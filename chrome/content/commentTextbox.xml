<bindings xmlns="http://www.mozilla.org/xbl"
          xmlns:xbl="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

    <binding id="commentTextbox" extends="chrome://global/content/bindings/autocomplete.xml#autocomplete">
        <implementation>
            <constructor><![CDATA[
                this.popup.__defineGetter__("overrideValue",
                                            this._utils.getOverrideValue);
            ]]></constructor>

            <field name="_beforeTag">""</field>
            <field name="_afterTag">""</field>
            <field name="_caretPos">-1</field>
            <field name="_utils">hBookmark.CommentUtils</field>

            <method name="adjustCaret">
                <parameter name="textEntered"/>
                <body><![CDATA[
                    let closerPos = this.value.indexOf("]", this._caretPos);
                    if (closerPos !== -1)
                        this.setSelectionRange(closerPos + 1, closerPos + 1);
                    //this.popup.invalidate();
                ]]></body>
            </method>

            <method name="memoCaret">
                <body><![CDATA[
                    this._caretPos = this.selectionStart;
                ]]></body>
            </method>

            <method name="_setSearchParam">
                <body><![CDATA[
                    let [head, tag, tail] = this._utils.splitComment(this.value, this.selectionStart);
                    this._beforeTag = head;
                    this._afterTag = tail;
                    this.searchParam = tag;
                ]]></body>
            </method>
        </implementation>

        <handlers>
            <handler event="input"
                     action="this._setSearchParam();"/>
            <handler event="keypress" phase="capturing"
                     action="this._setSearchParam();"/>
        </handlers>
    </binding>

</bindings>
