<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE bindings SYSTEM "chrome://hatenabookmark/locale/addPanel.dtd">
<bindings xmlns="http://www.mozilla.org/xbl"
          xmlns:xbl="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

    <binding id="add-panel"
             extends="chrome://global/content/bindings/popup.xml#panel">
        <content>
            <xul:hbox>
                <xul:image anonid="userIcon"/>
                <xul:label anonid="userNameField"
                           class="text-link hBookmarkLink"/>
            </xul:hbox>
            <xul:label anonid="errorField" hidden="true"/>
            <xul:grid>
                <xul:columns>
                    <xul:column/>
                    <xul:column flex="1"/>
                </xul:columns>
                <xul:rows>
                    <xul:row align="center">
                        <xul:label value="&hBookmark.addPanel.titleLabel;"/>
                        <xul:hbox align="center">
                            <xul:textbox anonid="titleField" flex="1"/>
                            <xul:button anonid="editTitleButton"
                                        label="&hBookmark.addPanel.editTitleLabel;"
                                        oncommand="var panel = document.getBindingParent(this); panel.isTitleEditable = true; panel.titleField.focus();"/>
                            <xul:button anonid="cancelEditTitleButton"
                                        label="&hBookmark.addPanel.cancelEditTitleLabel;"
                                        oncommand="document.getBindingParent(this).isTitleEditable = false;"/>
                        </xul:hbox>
                    </xul:row>
                    <xul:row align="center">
                        <xul:label value="&hBookmark.addPanel.urlLabel;"/>
                        <xul:label anonid="urlField"
                                   class="text-link hBookmarkLink"
                                   crop="end"/>
                    </xul:row>
                    <xul:row align="center">
                        <xul:label value="&hBookmark.addPanel.commentLabel;"/>
                        <xul:textbox
                            anonid="commentField"
                            class="hBookmarkMyTagComplete"
                        />
                    </xul:row>
                </xul:rows>
            </xul:grid>
        </content>

        <implementation>
            <constructor><![CDATA[
                this.inputHandler = new hBookmark.TagCompleter.InputHandler(this.commentField.inputField);
            ]]></constructor>

            <field name="userIcon">
                document.getAnonymousElementByAttribute(this, "anonid", "userIcon")
            </field>
            <field name="userNameField">
                document.getAnonymousElementByAttribute(this, "anonid", "userNameField")
            </field>
            <field name="titleField">
                document.getAnonymousElementByAttribute(this, "anonid", "titleField")
            </field>
            <field name="editTitleButton">
                document.getAnonymousElementByAttribute(this, "anonid", "editTitleButton")
            </field>
            <field name="cancelEditTitleButton">
                document.getAnonymousElementByAttribute(this, "anonid", "cancelEditTitleButton")
            </field>
            <field name="urlField">
                document.getAnonymousElementByAttribute(this, "anonid", "urlField")
            </field>
            <field name="commentField">
                document.getAnonymousElementByAttribute(this, "anonid", "commentField")
            </field>
            <field name="errorField">
                document.getAnonymousElementByAttribute(this, "anonid", "errorField")
            </field>
            <field name="dialog">
                document.documentElement

            </field>

            <field name="strings">
                new hBookmark.Strings("chrome://hatenabookmark/locale/addPanel.properties")
            </field>

            <field name="_bookmark">({ title: "", url: "", comment: "" })</field>
            <field name="_originalTitle">""</field>

            <property name="bookmark">
                <getter><![CDATA[
                    return hBookmark.extend(this._bookmark, {
                        title:   this.titleField.value,
                        url:     this.urlField.value,
                        comment: this.commentField.value
                    });
                ]]></getter>
                <setter><![CDATA[
                    if (val.url !== this._bookmark.url)
                        this.updateFields(val);
                    return this._bookmark = val;
                ]]></setter>
            </property>

            <property name="isTitleEditable"
                      onget="return !this.titleField.readOnly;">
                <setter><![CDATA[
                    this.titleField.readOnly = !val;
                    this.editTitleButton.hidden = val;
                    this.cancelEditTitleButton.hidden = !val;
                    if (!val)
                        this.titleField.value = this._originalTitle;
                    return val;
                ]]></setter>
            </property>

            <property name="isTitleChanged" readonly="true"
                      onget="return this.titleField.value !== this._originalTitle;"/>

            <method name="show">
                <parameter name="bookmark"/>
                <body><![CDATA[
                    this.bookmark = bookmark;
                    this.setAddOrEdit(!!bookmark.temporary);
                    this.clearError();
                    // 遅延しないとうまく focus があたらない？
                    // これでもタイミング次第では focus あわないので:w
                    // panel の表示にあわせて focus したほうがよいかも
                    setTimeout(function(self) {
                    self.commentField.focus();
                    }, 10, this);
                ]]></body>
            </method>

            <method name="hide">
                <body><![CDATA[
                    this.dialog.cancelDialog();
                ]]></body>
            </method>

            <method name="updateFields">
                <parameter name="bookmark"/>
                <body><![CDATA[
                    this._originalTitle     = bookmark.title;
                    this.titleField.value   = bookmark.title;
                    this.isTitleEditable    = false;
                    this.urlField.value     = bookmark.url;
                    this.urlField.href      = bookmark.url;
                    this.commentField.value = bookmark.comment;
                    let user = hBookmark.User.user;
                    this.userNameField.value = user.name;
                    this.userNameField.href = user.bookmarkHomepage;
                    let iconURL = user.getProfileIcon(false);
                    new hBookmark.IconLoader(iconURL, function (dataURL) {
                        this.userIcon.src = dataURL;
                    }, this);
                    setTimeout(function (self) {
                        let res = hBookmark.HTTPCache.entry.get(bookmark.url, true);
                        if (!res) {
                            let xhr = hBookmark.net.get(bookmark.url);
                            // とりあえずやっつけ
                            // loading icon だしたほうがよさそう
                            let m = (xhr.responseText || '').match(new RegExp('<title>(.+)</title>', 'i'));
                            if (m) {
                                self._originalTitle   = m[1];
                                self.titleField.value = m[1];
                            }
                        } else {
                            if (res.title === bookmark.title) return;
                            if (res) {
                                self._originalTitle   = res.title;
                                self.titleField.value = res.title;
                            }
                        }
                    }, 0, this);
                ]]></body>
            </method>

            <method name="setAddOrEdit">
                <parameter name="add"/>
                <body><![CDATA[
                    let type = add ? ".add" : ".edit";
                    document.title =
                        this.strings.get("title" + type);
                    this.dialog.getButton("accept").label =
                        this.strings.get("saveLabel" + type);
                ]]></body>
            </method>

            <method name="setError">
                <parameter name="message"/>
                <body><![CDATA[
                    this.errorField.value = message;
                    this.errorField.hidden = false;
                ]]></body>
            </method>

            <method name="clearError">
                <parameter name="message"/>
                <body><![CDATA[
                    this.errorField.hidden = true;
                ]]></body>
            </method>

            <method name="saveBookmark">
                <body><![CDATA[
                    let command = new hBookmark.RemoteCommand("edit", {
                        bookmark: this.bookmark,
                        changeTitle: this.isTitleChanged,
                        onError: let (self = this) function () {
                            let win = getTopWin();
                            //self.setError('error');
                            //self.show(bookmark);
                            //win.alert('error');
                            win.hBookmark.AddPanelManager.showPanel(bookmark);
                        }
                    });
                    command.execute();
                ]]></body>
            </method>
        </implementation>
    </binding>

    <binding id="tag-complete" extends="chrome://global/content/bindings/autocomplete.xml#autocomplete">
        <implementation implements="nsIObserver">
            <constructor><![CDATA[
                this.popup.__defineGetter__("overrideValue",
                                            this._popup_getOverrideValue);
                let os = hBookmark.ObserverService;
                os.addObserver(this, "autocomplete-will-enter-text", false);
                os.addObserver(this, "autocomplete-did-enter-text", false);
            ]]></constructor>

            <destructor><![CDATA[
                let os = hBookmark.ObserverService;
                os.removeObserver(this, "autocomplete-will-enter-text");
                os.removeObserver(this, "autocomplete-did-enter-text");
            ]]></destructor>

            <field name="_beforeTag">""</field>
            <field name="_afterTag">""</field>

            <field name="_isCompleting">false</field>
            <field name="_caretPos">0</field>

            <method name="_setSearchParam">
                <body><![CDATA[
                    let comment = this.value;
                    let caretPos = this.selectionStart;

                    let before = comment.substring(0, caretPos);
                    let after = comment.substring(caretPos);
                    let partialTag = "";
                    let match;
                    if ((match = /^(?:\[[^?%\/\[\]]+\])*\[([^?%\/\[\]]+)$/.exec(before))) {
                        partialTag = match[1];
                        before = before.slice(0, -partialTag.length);
                    }
                    if ((match = /^[^?%\/\[\]]*(?=\])/.exec(after))) {
                        partialTag += match[0];
                        after = after.substring(match[0].length);
                    } else {
                        after = "]" + after;
                    }

                    this._beforeTag = before;
                    this._afterTag = after;
                    this.searchParam = partialTag;
                    //hBookmark.p("[@_setSearchParam]", before, partialTag, after);
                ]]></body>
            </method>

            <method name="_popup_getOverrideValue">
                <body><![CDATA[
                    let input = this.input;
                    let tree = this.tree;
                    let col = tree.columns.getNamedColumn("treecolAutoCompleteValue");
                    return input._beforeTag +
                           tree.view.getCellText(tree.currentIndex, col) +
                           input._afterTag;
                ]]></body>
            </method>

            <method name="_adjustCaretPos">
                <body><![CDATA[
                    let pos = this.value.indexOf("]", this._caretPos);
                    if (pos !== -1)
                        this.setSelectionRange(pos + 1, pos + 1);
                ]]></body>
            </method>

            <method name="observe">
                <parameter name="subject"/>
                <parameter name="topic"/>
                <parameter name="data"/>
                <body><![CDATA[
                    if (subject !== this) return;
                    if (topic === "autocomplete-will-enter-text")
                        this._caretPos = this.selectionStart;
                    else
                        this._adjustCaretPos();
                ]]></body>
            </method>
        </implementation>

        <handlers>
            <handler event="input"
                     action="if (!this._isCompleting) this._setSearchParam();"/>
            <handler event="keypress" phase="capturing"
                     action="this._setSearchParam();"/>
        </handlers>
    </binding>

    <binding id="link"
             extends="chrome://global/content/bindings/text.xml#text-link">
        <implementation>
            <method name="open">
                <parameter name="event"/>
                <body><![CDATA[
                    let href = this.href;
                    if (!href || this.disabled || event.getPreventDefault())
                        return;
                    openUILink(href, event);
                ]]></body>
            </method>
        </implementation>
    </binding>

</bindings>
